<!DOCTYPE html>
<html>
<head>
    <title>Cookie Auth Test</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body>
    <h1>Cookie Authentication Test</h1>
    
    <div id="test-results">
        <h2>Testing Steps:</h2>
        <div id="step1">Step 1: Initial login test...</div>
        <div id="step2">Step 2: Dashboard access...</div>
        <div id="step3">Step 3: Session validation...</div>
    </div>
    
    <!-- Login Form Test -->
    <div style="margin-top: 20px; padding: 20px; border: 1px solid #ccc;">
        <h3>Direct Login Form</h3>
        <form hx-post="https://06ad2ef8.aria5-ti-enhancement.pages.dev/auth/login" 
              hx-target="#form-result">
            <input type="text" name="username" value="admin" placeholder="Username">
            <input type="password" name="password" value="demo123" placeholder="Password">
            <button type="submit">Login with HTMX</button>
        </form>
        <div id="form-result" style="margin-top: 10px;"></div>
    </div>

    <script>
    async function runTests() {
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        
        try {
            // Step 1: Login
            step1.innerHTML = 'Step 1: Logging in...';
            
            const loginResponse = await fetch('https://06ad2ef8.aria5-ti-enhancement.pages.dev/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'username=admin&password=demo123',
                credentials: 'include'
            });
            
            if (loginResponse.ok) {
                step1.innerHTML = '✅ Step 1: Login successful!';
                
                // Step 2: Dashboard access
                step2.innerHTML = 'Step 2: Accessing dashboard...';
                
                const dashboardResponse = await fetch('https://06ad2ef8.aria5-ti-enhancement.pages.dev/dashboard', {
                    credentials: 'include'
                });
                
                if (dashboardResponse.ok && !dashboardResponse.redirected) {
                    const dashboardText = await dashboardResponse.text();
                    if (dashboardText.includes('Executive Dashboard')) {
                        step2.innerHTML = '✅ Step 2: Dashboard accessible!';
                        
                        // Step 3: Session validation
                        step3.innerHTML = 'Step 3: Validating session...';
                        
                        const sessionResponse = await fetch('https://06ad2ef8.aria5-ti-enhancement.pages.dev/auth/session', {
                            credentials: 'include'
                        });
                        
                        if (sessionResponse.ok) {
                            const sessionData = await sessionResponse.json();
                            step3.innerHTML = `✅ Step 3: Session valid! User: ${sessionData.user.username} (${sessionData.user.role})`;
                        } else {
                            step3.innerHTML = '❌ Step 3: Session validation failed';
                        }
                    } else {
                        step2.innerHTML = '❌ Step 2: Dashboard shows login content';
                    }
                } else {
                    step2.innerHTML = '❌ Step 2: Dashboard redirected to login';
                }
            } else {
                step1.innerHTML = '❌ Step 1: Login failed';
            }
            
        } catch (error) {
            document.getElementById('test-results').innerHTML += `<br>❌ Error: ${error.message}`;
        }
    }
    
    // Auto-run tests
    runTests();
    </script>
</body>
</html>