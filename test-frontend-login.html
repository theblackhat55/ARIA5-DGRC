<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Frontend Login Test</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
</head>
<body class="bg-gray-100 p-8">
  <div class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-lg">
    <h2 class="text-2xl font-bold mb-4">Frontend Login Test</h2>
    
    <form id="test-login-form">
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2">Username</label>
        <input type="text" id="test-username" value="admin" class="w-full px-3 py-2 border rounded-lg">
      </div>
      
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2">Password</label>
        <input type="password" id="test-password" value="demo123" class="w-full px-3 py-2 border rounded-lg">
      </div>
      
      <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
        Test Login
      </button>
    </form>
    
    <div id="test-result" class="mt-4 p-4 rounded-lg hidden"></div>
    
    <div class="mt-6">
      <h3 class="font-semibold mb-2">Token Status:</h3>
      <div id="token-status" class="text-sm text-gray-600"></div>
    </div>
    
    <div class="mt-4">
      <button onclick="checkAuth()" class="bg-green-600 text-white px-4 py-2 rounded mr-2">Check Auth</button>
      <button onclick="clearTokens()" class="bg-red-600 text-white px-4 py-2 rounded">Clear Tokens</button>
    </div>
  </div>

  <script>
    const resultDiv = document.getElementById('test-result');
    const tokenStatus = document.getElementById('token-status');
    
    function showResult(message, type = 'info') {
      resultDiv.className = `mt-4 p-4 rounded-lg ${type === 'success' ? 'bg-green-100 text-green-800' : 
                                                    type === 'error' ? 'bg-red-100 text-red-800' : 
                                                    'bg-blue-100 text-blue-800'}`;
      resultDiv.textContent = message;
      resultDiv.classList.remove('hidden');
    }
    
    function updateTokenStatus() {
      const token = localStorage.getItem('dmt_token');
      const expiresAt = localStorage.getItem('dmt_expires_at');
      const user = localStorage.getItem('dmt_user');
      
      if (token) {
        const userObj = user ? JSON.parse(user) : null;
        tokenStatus.innerHTML = `
          <div class="text-green-600">✅ Token Found</div>
          <div>User: ${userObj ? userObj.username : 'Unknown'}</div>
          <div>Expires: ${expiresAt ? new Date(expiresAt).toLocaleString() : 'Unknown'}</div>
        `;
      } else {
        tokenStatus.innerHTML = '<div class="text-red-600">❌ No Token</div>';
      }
    }
    
    async function checkAuth() {
      const token = localStorage.getItem('dmt_token');
      if (!token) {
        showResult('No token found', 'error');
        return;
      }
      
      try {
        const response = await axios.get('/api/auth/me', {
          headers: { Authorization: `Bearer ${token}` }
        });
        
        if (response.data.success) {
          showResult(`Auth check successful: ${response.data.data.username}`, 'success');
        } else {
          showResult('Auth check failed: Invalid token', 'error');
        }
      } catch (error) {
        showResult(`Auth check failed: ${error.message}`, 'error');
      }
    }
    
    function clearTokens() {
      localStorage.removeItem('dmt_token');
      localStorage.removeItem('dmt_expires_at');
      localStorage.removeItem('dmt_user');
      localStorage.removeItem('dmt_access_token');
      localStorage.removeItem('dmt_refresh_token');
      localStorage.removeItem('dmt_token_expires');
      updateTokenStatus();
      showResult('All tokens cleared', 'info');
    }
    
    document.getElementById('test-login-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const username = document.getElementById('test-username').value;
      const password = document.getElementById('test-password').value;
      
      if (!username || !password) {
        showResult('Username and password required', 'error');
        return;
      }
      
      showResult('Attempting login...', 'info');
      
      try {
        const response = await axios.post('/api/auth/login', {
          username: username,
          password: password
        });
        
        if (response.data.success) {
          // Store token
          localStorage.setItem('dmt_token', response.data.data.token);
          localStorage.setItem('dmt_expires_at', response.data.data.expires_at);
          localStorage.setItem('dmt_user', JSON.stringify(response.data.data.user));
          
          showResult(`Login successful! Welcome ${response.data.data.user.first_name || response.data.data.user.username}`, 'success');
          updateTokenStatus();
        } else {
          showResult(`Login failed: ${response.data.error}`, 'error');
        }
      } catch (error) {
        console.error('Login error:', error);
        showResult(`Login error: ${error.response?.data?.error || error.message}`, 'error');
      }
    });
    
    // Initialize
    updateTokenStatus();
  </script>
</body>
</html>